# reX.ts デプロイ・運用のトラブルシューティングガイド

## 目次
1. [デプロイ関連の問題](#デプロイ関連の問題)
2. [Docker関連の問題](#Docker関連の問題)
3. [アプリケーション実行時の問題](#アプリケーション実行時の問題)
4. [モニタリング関連の問題](#モニタリング関連の問題)
5. [SSL/TLS関連の問題](#SSL/TLS関連の問題)
6. [ネットワーク関連の問題](#ネットワーク関連の問題)
7. [サーバーリソース関連の問題](#サーバーリソース関連の問題)
8. [Vercelデプロイ関連の問題](#Vercelデプロイ関連の問題)
9. [API接続関連の問題](#API接続関連の問題)
10. [GitHub Pages関連の問題](#GitHub-Pages関連の問題)

---

## デプロイ関連の問題

### GitHub Actionsが失敗する

**症状**:
GitHub Actionsのワークフローが失敗し、本番環境へのデプロイができない。

**解決策**:

1. Actionsタブでログを確認して具体的なエラーを特定
2. 主な失敗原因と解決策:
   - GitHubシークレットの設定ミス → シークレットの値を再確認・更新
   - SSH接続の問題 → SSH鍵の設定とサーバーのauthorized_keysを確認
   - DockerHub認証エラー → DockerHubトークンの有効期限や権限を確認
   - ビルドエラー → コード修正後に再デプロイ

```bash
# SSH接続のテスト
ssh -i /path/to/private_key your_username@your_server_ip

# DockerHub認証のテスト
docker login -u $DOCKER_HUB_USERNAME -p $DOCKER_HUB_TOKEN
```

### 手動デプロイの失敗

**症状**:
サーバーでdocker-composeコマンドを実行してもアプリケーションが起動しない。

**解決策**:

1. docker-composeのログを確認:
```bash
cd /opt/rex-deployment
docker-compose logs
```

2. 環境変数ファイル(.env)が正しく設定されているか確認:
```bash
cat /opt/rex-deployment/.env
```

3. Dockerイメージの存在を確認:
```bash
docker images | grep rex
```

4. 必要に応じてイメージを手動で取得:
```bash
docker pull your_dockerhub_username/rex-backend:latest
docker pull your_dockerhub_username/rex-frontend:latest
```

### デプロイスクリプトの実行エラー

**症状**:
deploy.shスクリプトの実行時にエラーが発生する。

**解決策**:

1. スクリプトのログを確認して特定のエラーを特定

2. 環境変数が正しく設定されているか確認:
```bash
echo $DOCKER_USERNAME
echo $GOOGLE_API_KEY
```

3. スクリプトに実行権限が付与されているか確認:
```bash
chmod +x deploy.sh
```

4. コンテナが既に実行中の場合は停止してから再デプロイ:
```bash
docker-compose down
./deploy.sh
```

---

## Docker関連の問題

### コンテナが起動しない

**症状**:
docker-compose upを実行してもコンテナが正常に起動しない。

**解決策**:

1. コンテナの状態を確認:
```bash
docker-compose ps
```

2. コンテナのログを確認:
```bash
docker-compose logs backend
docker-compose logs frontend
```

3. コンテナの起動履歴を確認:
```bash
docker ps -a
```

4. 問題のあるコンテナを再ビルド:
```bash
docker-compose build --no-cache backend
docker-compose up -d
```

### Docker関連のディスク容量問題

**症状**:
「no space left on device」エラーが発生。

**解決策**:

1. ディスク使用状況を確認:
```bash
df -h
```

2. 未使用のDockerリソースをクリーンアップ:
```bash
docker system prune -a --volumes
```

3. ログファイルのローテーションを確認:
```bash
ls -la /var/log/
```

---

## アプリケーション実行時の問題

### バックエンドAPIエラー

**症状**:
フロントエンドからバックエンドへのAPI呼び出しが失敗する。

**解決策**:

1. バックエンドのログを確認:
```bash
docker-compose logs backend
```

2. バックエンドのヘルスチェックを実行:
```bash
curl http://localhost:3001/health
```

3. 環境変数が正しく設定されているか確認:
```bash
docker-compose exec backend env | grep GOOGLE_API_KEY
```

4. GOOGLE_API_KEYの有効性確認（例: Gemini APIの場合）:
```bash
curl -H "Authorization: Bearer $GOOGLE_API_KEY" https://generativelanguage.googleapis.com/v1beta/models
```

5. ネットワーク接続を確認:
```bash
docker-compose exec backend ping 8.8.8.8
```

### フロントエンドエラー

**症状**:
フロントエンドの画面が正常に表示されない、または機能が動作しない。

**解決策**:

1. フロントエンドのログを確認:
```bash
docker-compose logs frontend
```

2. 環境変数を確認:
```bash
docker-compose exec frontend env | grep NEXT_PUBLIC
```

3. ブラウザのコンソールエラーを確認

4. フロントエンドのビルドを再実行:
```bash
docker-compose exec frontend npm run build
```

---

## モニタリング関連の問題

### Prometheusが起動しない

**症状**:
Prometheusコンテナが起動しない、またはクラッシュする。

**解決策**:

1. Prometheusのログを確認:
```bash
docker-compose -f monitoring-docker-compose.yml logs prometheus
```

2. prometheus.ymlファイルの構文を確認:
```bash
cat /opt/rex-monitoring/prometheus.yml
```

3. 設定ファイルを修正して再起動:
```bash
docker-compose -f monitoring-docker-compose.yml restart prometheus
```

### Grafanaにデータが表示されない

**症状**:
Grafanaにログインできるが、ダッシュボードにデータが表示されない。

**解決策**:

1. Prometheusのターゲットが正常かチェック:
   - ブラウザで http://your_server_ip:9090/targets にアクセス
   - すべてのターゲットのステータスが「UP」になっているか確認

2. Grafanaのデータソース設定を確認:
   - URL: `http://prometheus:9090`
   - アクセス: Server (デフォルト)

3. 監視対象のサービスのメトリクスエンドポイントを確認:
```bash
curl http://localhost:3001/metrics
```

### アラート通知が機能しない

**症状**:
システムの異常が発生してもSlackに通知が届かない。

**解決策**:

1. AlertManagerの設定を確認:
```bash
cat /opt/rex-monitoring/alertmanager.yml
```

2. Slack Webhook URLの有効性を確認

3. AlertManagerのログを確認:
```bash
docker-compose -f monitoring-docker-compose.yml logs alertmanager
```

4. AlertManagerを再起動:
```bash
docker-compose -f monitoring-docker-compose.yml restart alertmanager
```

---

## SSL/TLS関連の問題

### SSL証明書エラー

**症状**:
ブラウザでサイトにアクセスすると、「接続が安全ではありません」などの警告が表示される。

**解決策**:

1. 証明書の状態を確認:
```bash
sudo certbot certificates
```

2. 証明書を更新:
```bash
sudo certbot renew
```

3. Nginxの設定を確認:
```bash
sudo nginx -t
```

4. 必要に応じてNginxを再起動:
```bash
sudo systemctl restart nginx
```

### 証明書の自動更新が機能しない

**症状**:
Let's Encryptの証明書が自動的に更新されない。

**解決策**:

1. Certbotのタイマーを確認:
```bash
sudo systemctl status certbot.timer
```

2. テスト実行を行う:
```bash
sudo certbot renew --dry-run
```

3. 自動更新サービスを再有効化:
```bash
sudo systemctl enable certbot.timer
sudo systemctl start certbot.timer
```

---

## ネットワーク関連の問題

### DNSの問題

**症状**:
ドメイン名でアクセスできない。

**解決策**:

1. DNSレコードの設定を確認

2. DNSの伝播を確認:
```bash
nslookup rexapp.example.com
dig rexapp.example.com
```

3. ローカルでhostsファイルを使ってテスト:
```
your_server_ip rexapp.example.com api.rexapp.example.com
```

### ファイアウォール問題

**症状**:
特定のポートやサービスにアクセスできない。

**解決策**:

1. ファイアウォールの状態を確認:
```bash
sudo ufw status
```

2. 必要なポートが開いているか確認:
```bash
sudo ufw status | grep '80\|443\|3000\|3001\|9090\|9093\|3030'
```

3. 必要に応じてポートを開放:
```bash
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
```

### API接続タイムアウト

**症状**:
バックエンドAPIへの接続が頻繁にタイムアウトする。

**解決策**:

1. ネットワークの状態を確認:
```bash
ping backend
traceroute backend
```

2. ファイアウォール設定を確認:
```bash
sudo ufw status
```

3. DNS解決を確認:
```bash
nslookup backend
```

4. タイムアウト設定を調整:
   - docker-compose.ymlのAPI_TIMEOUTパラメータを増やす
   - フロントエンドのapiService.tsでタイムアウト設定を増やす

5. ロードバランサーの設定を確認（使用している場合）

### VPN接続の問題

**症状**:
VPNを使用している環境で接続が失敗する。

**解決策**:

1. VPN接続の状態を確認:
```bash
ifconfig tun0
```

2. VPNを一時的に無効にして接続テスト:
```bash
# VPN無効化後
curl http://localhost:3001/health
```

3. VPNのDNS設定を確認・修正:
```bash
cat /etc/resolv.conf
```

4. プロキシ設定を確認:
```bash
echo $http_proxy
echo $https_proxy
```

5. 環境変数に適切なプロキシ設定を追加:
```bash
export HTTP_PROXY=http://proxy.example.com:8080
export HTTPS_PROXY=http://proxy.example.com:8080
export NO_PROXY=localhost,127.0.0.1
```

## Vercelデプロイ関連の問題

### Vercelデプロイ失敗

**症状**:
Vercelへのデプロイが失敗し、「Connection failed」または「Error ID」のエラーが表示される。

**解決策**:

1. Vercel CLIの認証情報を確認:
```bash
vercel whoami
```

2. Vercel CLIを再認証:
```bash
vercel login
```

3. 手動でデプロイを実行:
```bash
cd frontend
vercel --prod
```

4. プロジェクト設定でデプロイメントの詳細ログを確認:
   - Vercelダッシュボードにアクセス
   - 該当プロジェクトの「Deployments」タブを選択
   - 失敗したデプロイメントをクリックして詳細ログを確認

5. ビルドエラーの場合は、ローカルでビルドしてからデプロイ:
```bash
cd frontend
npm run build
vercel deploy --prebuilt --prod
```

### Vercelの環境変数問題

**症状**:
デプロイは成功するが、APIリクエストが失敗したり、環境変数が正しく適用されない。

**解決策**:

1. Vercelダッシュボードで環境変数を確認・設定:
   - Vercelプロジェクト → Settings → Environment Variables
   - `NEXT_PUBLIC_API_BASE_URL`が正しく設定されているか確認

2. vercel.jsonファイルで環境変数を設定:
```json
{
  "env": {
    "NEXT_PUBLIC_API_BASE_URL": "https://api.rexapp.example.com"
  }
}
```

3. 環境変数の優先順位を確認:
   - Vercelダッシュボード > プロジェクト設定
   - Environment Variables > Environment Variable Precedence

4. プロジェクトを再デプロイして変更を適用:
```bash
vercel --prod
```

## API接続関連の問題

### Google Gemini API接続エラー

**症状**:
「Connection failed」メッセージが表示され、Gemini APIへの接続が失敗する。

**解決策**:

1. APIキーが有効か確認:
```bash
curl -H "Authorization: Bearer $GOOGLE_API_KEY" \
  https://generativelanguage.googleapis.com/v1beta/models
```

2. APIキーの制限や課金設定を確認:
   - Google Cloud Consoleでキーの制限を確認
   - 課金アカウントが有効か確認

3. リクエスト率の制限に達していないか確認:
   - Google Cloud Consoleでクォータを確認
   - エラーメッセージに「quota exceeded」があれば制限に達している

4. プロキシやVPN設定を確認:
   - プロキシ環境変数が正しく設定されているか
   - VPNが接続を妨げていないか

5. バックエンドの環境変数を更新:
```bash
docker-compose exec backend bash -c 'echo $GOOGLE_API_KEY'
```

6. 一時的なインターネット接続問題の場合はリトライ:
   - フロントエンドの「再接続を試みる」ボタンを使用
   - またはバックエンドサービスを再起動:
```bash
docker-compose restart backend
```

## GitHub Pages関連の問題

### GitHub Pagesへのアクセスエラー

**症状**:
GitHub Pagesのページにアクセスすると404エラーが表示される。

**解決策**:

1. デプロイ状況を確認:
   - リポジトリの「Actions」タブでGitHub Pagesデプロイワークフローの実行状況を確認
   - 最新のワークフローが成功していることを確認

2. GitHub Pages設定を確認:
   - リポジトリの「Settings」→「Pages」で設定を確認
   - Sourceが `gh-pages` ブランチに設定されていることを確認
   - カスタムドメインの設定が正しいか確認（設定している場合）

3. ブラウザのキャッシュをクリア:
```bash
# Chromeの場合は以下のショートカット
Ctrl+Shift+Delete (Windows/Linux)
Command+Shift+Delete (Mac)
```

4. リポジトリ名と一致するかを確認:
   - URLが `https://[ユーザー名].github.io/[リポジトリ名]/` の形式になっているか確認

### GitHub Pagesのデプロイ失敗

**症状**:
GitHub Actionsワークフローでのデプロイが失敗する。

**解決策**:

1. ワークフローログを確認:
   - 「Actions」タブで失敗したワークフローを選択して詳細ログを確認

2. Nextアプリのエクスポート設定を確認:
```bash
# next.config.jsに以下の設定が必要
module.exports = {
  output: 'export'
}
```

3. パーミッション設定を確認:
   - リポジトリの「Settings」→「Actions」→「General」で「Workflow permissions」が「Read and write permissions」に設定されていることを確認

4. 手動でデプロイを実行:
```bash
cd frontend
npm run build
npm run export
npx gh-pages -d out
```

### GitHub Pagesで画像やアセットが読み込まれない

**症状**:
ページは表示されるが、画像やCSS等のアセットが読み込まれない。

**解決策**:

1. パス設定を確認:
   - リポジトリのベースパスが正しく設定されているか確認
   - `next.config.js` に以下の設定が必要
```javascript
module.exports = {
  basePath: '/reX.ts',
  assetPrefix: '/reX.ts/'
}
```

2. 相対パスを使用:
   - アセットの参照には相対パスを使用

3. 404エラーのあるファイルを特定:
   - ブラウザの開発者ツールのネットワークタブでエラーを確認し、パスを修正

4. CORSヘッダーを確認:
   - GitHub Pagesではカスタムヘッダーが設定できないため、アセットにはクロスオリジンの考慮が必要

### GitHub Pagesとバックエンドの接続問題

**症状**:
GitHub PagesからVercelでホストされているバックエンドAPIへの接続が失敗する。

**解決策**:

1. CORS設定を確認:
   - バックエンドのCORS設定でGitHub Pagesのドメインが許可されているか確認
```javascript
// backend/index.jsのCORS設定
const corsOptions = {
  origin: [
    // 既存の設定
    'https://kinouecertify-gmailcoms-projects.github.io'
  ],
  // 他の設定
};
```

2. API URLの環境変数を確認:
   - フロントエンドのデプロイ設定でバックエンドURLが正しく指定されているか確認
```yaml
# GitHub Actionsワークフロー
NEXT_PUBLIC_API_BASE_URL=https://backend-iqep5txo6-kinouecertify-gmailcoms-projects.vercel.app
```

3. HTTPS通信の確認:
   - GitHub PagesではHTTPSが強制されるため、バックエンドもHTTPSである必要がある
   - バックエンドURLが `https://` で始まることを確認

4. ネットワークリクエストを確認:
   - ブラウザの開発者ツールでAPIリクエストのエラーを確認

5. フェールバック対応:
   - GitHub Pagesでの接続問題が継続する場合は、Vercelのフロントエンドデプロイを優先的に使用

---

## サーバーリソース関連の問題

### CPU/メモリ使用率が高い

**症状**:
サーバーのレスポンスが遅い、またはGrafanaのモニタリングでリソース使用率が高い。

**解決策**:

1. リソース使用状況を確認:
```bash
htop
```

2. Dockerコンテナのリソース使用状況を確認:
```bash
docker stats
```

3. 問題のあるコンテナを再起動:
```bash
docker-compose restart service_name
```

4. 必要に応じてサーバースペックをアップグレード

### ディスク容量の問題

**症状**:
ディスク容量が不足している。

**解決策**:

1. ディスク使用状況を確認:
```bash
df -h
```

2. 大きなファイルやディレクトリを特定:
```bash
sudo du -h --max-depth=1 /
```

3. 古いログファイルを削除:
```bash
find /var/log -type f -name "*.log" -mtime +30 -delete
```

4. Dockerのクリーンアップ:
```bash
docker system prune -a --volumes
```

5. 必要に応じてストレージを増設 