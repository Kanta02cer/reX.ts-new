# reX.ts デプロイ・運用のトラブルシューティングガイド

## 目次
1. [デプロイ関連の問題](#デプロイ関連の問題)
2. [Docker関連の問題](#Docker関連の問題)
3. [アプリケーション実行時の問題](#アプリケーション実行時の問題)
4. [モニタリング関連の問題](#モニタリング関連の問題)
5. [SSL/TLS関連の問題](#SSL/TLS関連の問題)
6. [ネットワーク関連の問題](#ネットワーク関連の問題)
7. [サーバーリソース関連の問題](#サーバーリソース関連の問題)

---

## デプロイ関連の問題

### GitHub Actionsが失敗する

**症状**:
GitHub Actionsのワークフローが失敗し、本番環境へのデプロイができない。

**解決策**:

1. Actionsタブでログを確認して具体的なエラーを特定
2. 主な失敗原因と解決策:
   - GitHubシークレットの設定ミス → シークレットの値を再確認・更新
   - SSH接続の問題 → SSH鍵の設定とサーバーのauthorized_keysを確認
   - DockerHub認証エラー → DockerHubトークンの有効期限や権限を確認
   - ビルドエラー → コード修正後に再デプロイ

```bash
# SSH接続のテスト
ssh -i /path/to/private_key your_username@your_server_ip

# DockerHub認証のテスト
docker login -u $DOCKER_HUB_USERNAME -p $DOCKER_HUB_TOKEN
```

### 手動デプロイの失敗

**症状**:
サーバーでdocker-composeコマンドを実行してもアプリケーションが起動しない。

**解決策**:

1. docker-composeのログを確認:
```bash
cd /opt/rex-deployment
docker-compose logs
```

2. 環境変数ファイル(.env)が正しく設定されているか確認:
```bash
cat /opt/rex-deployment/.env
```

3. Dockerイメージの存在を確認:
```bash
docker images | grep rex
```

4. 必要に応じてイメージを手動で取得:
```bash
docker pull your_dockerhub_username/rex-backend:latest
docker pull your_dockerhub_username/rex-frontend:latest
```

---

## Docker関連の問題

### コンテナが起動しない

**症状**:
docker-compose upを実行してもコンテナが正常に起動しない。

**解決策**:

1. コンテナの状態を確認:
```bash
docker-compose ps
```

2. コンテナのログを確認:
```bash
docker-compose logs backend
docker-compose logs frontend
```

3. コンテナの起動履歴を確認:
```bash
docker ps -a
```

4. 問題のあるコンテナを再ビルド:
```bash
docker-compose build --no-cache backend
docker-compose up -d
```

### Docker関連のディスク容量問題

**症状**:
「no space left on device」エラーが発生。

**解決策**:

1. ディスク使用状況を確認:
```bash
df -h
```

2. 未使用のDockerリソースをクリーンアップ:
```bash
docker system prune -a --volumes
```

3. ログファイルのローテーションを確認:
```bash
ls -la /var/log/
```

---

## アプリケーション実行時の問題

### バックエンドAPIエラー

**症状**:
フロントエンドからバックエンドへのAPI呼び出しが失敗する。

**解決策**:

1. バックエンドのログを確認:
```bash
docker-compose logs backend
```

2. バックエンドのヘルスチェックを実行:
```bash
curl http://localhost:3001/health
```

3. 環境変数が正しく設定されているか確認:
```bash
docker-compose exec backend env | grep GOOGLE_API_KEY
```

4. GOOGLE_API_KEYの有効性確認（例: Gemini APIの場合）:
```bash
curl -H "Authorization: Bearer $GOOGLE_API_KEY" https://generativelanguage.googleapis.com/v1beta/models
```

5. ネットワーク接続を確認:
```bash
docker-compose exec backend ping 8.8.8.8
```

### フロントエンドエラー

**症状**:
フロントエンドの画面が正常に表示されない、または機能が動作しない。

**解決策**:

1. フロントエンドのログを確認:
```bash
docker-compose logs frontend
```

2. 環境変数を確認:
```bash
docker-compose exec frontend env | grep NEXT_PUBLIC
```

3. ブラウザのコンソールエラーを確認

4. フロントエンドのビルドを再実行:
```bash
docker-compose exec frontend npm run build
```

---

## モニタリング関連の問題

### Prometheusが起動しない

**症状**:
Prometheusコンテナが起動しない、またはクラッシュする。

**解決策**:

1. Prometheusのログを確認:
```bash
docker-compose -f monitoring-docker-compose.yml logs prometheus
```

2. prometheus.ymlファイルの構文を確認:
```bash
cat /opt/rex-monitoring/prometheus.yml
```

3. 設定ファイルを修正して再起動:
```bash
docker-compose -f monitoring-docker-compose.yml restart prometheus
```

### Grafanaにデータが表示されない

**症状**:
Grafanaにログインできるが、ダッシュボードにデータが表示されない。

**解決策**:

1. Prometheusのターゲットが正常かチェック:
   - ブラウザで http://your_server_ip:9090/targets にアクセス
   - すべてのターゲットのステータスが「UP」になっているか確認

2. Grafanaのデータソース設定を確認:
   - URL: `http://prometheus:9090`
   - アクセス: Server (デフォルト)

3. 監視対象のサービスのメトリクスエンドポイントを確認:
```bash
curl http://localhost:3001/metrics
```

### アラート通知が機能しない

**症状**:
システムの異常が発生してもSlackに通知が届かない。

**解決策**:

1. AlertManagerの設定を確認:
```bash
cat /opt/rex-monitoring/alertmanager.yml
```

2. Slack Webhook URLの有効性を確認

3. AlertManagerのログを確認:
```bash
docker-compose -f monitoring-docker-compose.yml logs alertmanager
```

4. AlertManagerを再起動:
```bash
docker-compose -f monitoring-docker-compose.yml restart alertmanager
```

---

## SSL/TLS関連の問題

### SSL証明書エラー

**症状**:
ブラウザでサイトにアクセスすると、「接続が安全ではありません」などの警告が表示される。

**解決策**:

1. 証明書の状態を確認:
```bash
sudo certbot certificates
```

2. 証明書を更新:
```bash
sudo certbot renew
```

3. Nginxの設定を確認:
```bash
sudo nginx -t
```

4. 必要に応じてNginxを再起動:
```bash
sudo systemctl restart nginx
```

### 証明書の自動更新が機能しない

**症状**:
Let's Encryptの証明書が自動的に更新されない。

**解決策**:

1. Certbotのタイマーを確認:
```bash
sudo systemctl status certbot.timer
```

2. テスト実行を行う:
```bash
sudo certbot renew --dry-run
```

3. 自動更新サービスを再有効化:
```bash
sudo systemctl enable certbot.timer
sudo systemctl start certbot.timer
```

---

## ネットワーク関連の問題

### DNSの問題

**症状**:
ドメイン名でアクセスできない。

**解決策**:

1. DNSレコードの設定を確認

2. DNSの伝播を確認:
```bash
nslookup rexapp.example.com
dig rexapp.example.com
```

3. ローカルでhostsファイルを使ってテスト:
```
your_server_ip rexapp.example.com api.rexapp.example.com
```

### ファイアウォール問題

**症状**:
特定のポートやサービスにアクセスできない。

**解決策**:

1. ファイアウォールの状態を確認:
```bash
sudo ufw status
```

2. 必要なポートが開いているか確認:
```bash
sudo ufw status | grep '80\|443\|3000\|3001\|9090\|9093\|3030'
```

3. 必要に応じてポートを開放:
```bash
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
```

---

## サーバーリソース関連の問題

### CPU/メモリ使用率が高い

**症状**:
サーバーのレスポンスが遅い、またはGrafanaのモニタリングでリソース使用率が高い。

**解決策**:

1. リソース使用状況を確認:
```bash
htop
```

2. Dockerコンテナのリソース使用状況を確認:
```bash
docker stats
```

3. 問題のあるコンテナを再起動:
```bash
docker-compose restart service_name
```

4. 必要に応じてサーバースペックをアップグレード

### ディスク容量の問題

**症状**:
ディスク容量が不足している。

**解決策**:

1. ディスク使用状況を確認:
```bash
df -h
```

2. 大きなファイルやディレクトリを特定:
```bash
sudo du -h --max-depth=1 /
```

3. 古いログファイルを削除:
```bash
find /var/log -type f -name "*.log" -mtime +30 -delete
```

4. Dockerのクリーンアップ:
```bash
docker system prune -a --volumes
```

5. 必要に応じてストレージを増設 