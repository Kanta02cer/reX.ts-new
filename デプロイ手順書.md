# reX.ts 本番環境デプロイ実施手順書

## 1. GitHubシークレットの設定

GitHubリポジトリの設定ページから、以下のシークレットを設定します：

1. リポジトリページで「Settings」タブを選択
2. 左側のメニューから「Secrets and variables」→「Actions」を選択
3. 「New repository secret」ボタンをクリックして、以下のシークレットを追加：

| シークレット名 | 値 | 説明 |
|--------------|----|----|
| `DOCKER_HUB_USERNAME` | `your_dockerhub_username` | DockerHubのユーザー名 |
| `DOCKER_HUB_TOKEN` | `your_dockerhub_token` | DockerHubのアクセストークン（[DockerHub](https://hub.docker.com/settings/security)で生成） |
| `PRODUCTION_HOST` | `your_server_ip` | 本番サーバーのIPアドレス（例：123.456.789.0） |
| `PRODUCTION_USERNAME` | `your_server_username` | 本番サーバーのSSHユーザー名（例：ubuntu） |
| `PRODUCTION_SSH_KEY` | `your_private_key` | 本番サーバーへのSSH秘密鍵（`cat ~/.ssh/id_rsa`で取得） |
| `GOOGLE_API_KEY` | `your_gemini_api_key` | Google Gemini APIのAPIキー |
| `SLACK_WEBHOOK` | `your_slack_webhook_url` | Slackの通知用Webhook URL |

## 2. 本番サーバーのセットアップ

### 2.1 サーバー準備

以下の要件を満たすサーバーを用意します：
- Ubuntu 20.04 LTS以上
- 最低2GBのRAM
- 最低1CPUコア（推奨2コア以上）
- 最低20GBのディスク容量

### 2.2 SSHアクセス設定

ローカルマシンから本番サーバーにSSH接続できることを確認します：

```bash
ssh your_username@your_server_ip
```

### 2.3 セットアップスクリプトの転送と実行

1. ローカルマシンからスクリプトを本番サーバーにコピー：

```bash
scp production-server-setup.sh your_username@your_server_ip:~/
```

2. スクリプトに実行権限を付与して実行：

```bash
ssh your_username@your_server_ip "chmod +x ~/production-server-setup.sh && sudo ~/production-server-setup.sh"
```

3. 実行後、以下のメッセージが表示されることを確認：
   ```
   セットアップが完了しました！
   ```

### 2.4 環境変数の設定

1. 本番サーバーの環境変数ファイルを編集：

```bash
ssh your_username@your_server_ip "sudo nano /opt/rex-deployment/.env"
```

2. 以下の内容に更新：

```
DOCKER_USERNAME=your_dockerhub_username
GOOGLE_API_KEY=your_gemini_api_key
```

3. Ctrl+O, Enterで保存し、Ctrl+Xで終了

## 3. DNSレコードの設定

使用するドメインのDNS管理ページで、以下のAレコードを追加：

| ホスト名 | タイプ | 値 |
|---------|------|-----|
| rexapp | A | your_server_ip |
| api.rexapp | A | your_server_ip |

## 4. SSL証明書の設定

本番サーバーでLet's EncryptによるSSL証明書を設定：

```bash
ssh your_username@your_server_ip "sudo apt-get update && sudo apt-get install -y certbot python3-certbot-nginx && sudo certbot --nginx -d rexapp.example.com -d api.rexapp.example.com"
```

表示される指示に従って設定を完了します。

## 5. 初回デプロイの実行

### 5.1 GitHub Actionsでのデプロイ

1. リポジトリのmainブランチに変更をプッシュするか、GitHub Actionsの「Deploy to Production」ワークフローを手動で実行：
   - GitHubリポジトリで「Actions」タブを選択
   - 左側から「Deploy to Production」ワークフローを選択
   - 「Run workflow」ボタンをクリック

2. ワークフローの完了を待ち、成功したことを確認

### 5.2 手動デプロイ（必要な場合）

GitHub Actionsでのデプロイが失敗した場合は、以下のコマンドで手動デプロイを実行：

```bash
ssh your_username@your_server_ip "cd /opt/rex-deployment && docker-compose pull && docker-compose up -d"
```

## 6. デプロイの確認

1. ブラウザで本番環境にアクセス：
   - フロントエンド: `https://rexapp.example.com`
   - バックエンドAPI: `https://api.rexapp.example.com/health`

2. 正常に表示されることを確認

## 7. モニタリングの設定

### 7.1 モニタリングファイルの転送

1. モニタリング用のファイルを本番サーバーに転送：

```bash
ssh your_username@your_server_ip "mkdir -p /opt/rex-monitoring"
scp monitoring-docker-compose.yml prometheus.yml blackbox.yml alertmanager.yml your_username@your_server_ip:/opt/rex-monitoring/
```

2. AlertManagerの設定を編集：

```bash
ssh your_username@your_server_ip "sudo nano /opt/rex-monitoring/alertmanager.yml"
```

3. Slackのwebhook URLを実際のものに変更：

```yaml
global:
  resolve_timeout: 5m
  slack_api_url: 'https://hooks.slack.com/services/your/actual/webhook'
```

### 7.2 モニタリングスタックの起動

```bash
ssh your_username@your_server_ip "cd /opt/rex-monitoring && sudo docker-compose -f monitoring-docker-compose.yml up -d"
```

### 7.3 Grafanaの設定

1. ブラウザで `http://your_server_ip:3030` にアクセス
2. デフォルトの認証情報でログイン：
   - ユーザー名: admin
   - パスワード: admin
3. パスワードを変更
4. データソースとして Prometheus を追加：
   - 「Configuration」→「Data sources」→「Add data source」→「Prometheus」
   - URL: `http://prometheus:9090`
   - アクセス: `Server (デフォルト)`
   - 「Save & Test」をクリック
5. ダッシュボードをインポート：
   - 「Create」→「Import」
   - 以下のダッシュボードIDを順に入力してインポート：
     - 1860（Node Exporter Full）
     - 893（Docker and system monitoring）
     - 7587（Blackbox Exporter）

## トラブルシューティング

### デプロイの問題

**問題**: GitHubからの自動デプロイが失敗する  
**解決策**: 
1. GitHub Actionsのログを確認
2. シークレットが正しく設定されているか確認
3. 手動でデプロイを試みる：
```bash
ssh your_username@your_server_ip "cd /opt/rex-deployment && docker-compose pull && docker-compose up -d"
```

**問題**: コンテナの起動に失敗する  
**解決策**:
1. コンテナログを確認：
```bash
ssh your_username@your_server_ip "cd /opt/rex-deployment && docker-compose logs -f"
```
2. 環境変数が正しく設定されているか確認
3. コンテナを再起動：
```bash
ssh your_username@your_server_ip "cd /opt/rex-deployment && docker-compose restart"
```

### モニタリングの問題

**問題**: Grafanaにデータが表示されない  
**解決策**:
1. Prometheusのステータスを確認：
```bash
ssh your_username@your_server_ip "cd /opt/rex-monitoring && docker-compose -f monitoring-docker-compose.yml ps"
```
2. PrometheusがターゲットにアクセスできるかブラウザでPrometheusUIを確認（http://your_server_ip:9090/targets）
3. モニタリングスタックを再起動：
```bash
ssh your_username@your_server_ip "cd /opt/rex-monitoring && docker-compose -f monitoring-docker-compose.yml restart"
```

**問題**: Slack通知が届かない  
**解決策**:
1. AlertManagerの設定を確認：
```bash
ssh your_username@your_server_ip "cat /opt/rex-monitoring/alertmanager.yml"
```
2. Slack WebhookのURLが正しいか確認
3. AlertManagerを再起動：
```bash
ssh your_username@your_server_ip "cd /opt/rex-monitoring && docker-compose -f monitoring-docker-compose.yml restart alertmanager"
```